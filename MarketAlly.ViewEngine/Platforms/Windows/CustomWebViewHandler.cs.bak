using Microsoft.UI.Xaml.Controls;
using Microsoft.Web.WebView2.Core;
using System.Diagnostics;
using System.Text.Json;

namespace MarketAlly.Maui.ViewEngine
{
	public partial class WebViewHandler
	{
		private Windows.Foundation.TypedEventHandler<CoreWebView2, CoreWebView2NewWindowRequestedEventArgs> _newWindowHandler;
		private Windows.Foundation.TypedEventHandler<CoreWebView2, CoreWebView2DownloadStartingEventArgs> _downloadHandler;
		private Windows.Foundation.TypedEventHandler<CoreWebView2, CoreWebView2SourceChangedEventArgs> _sourceChangedHandler;
		private Windows.Foundation.TypedEventHandler<CoreWebView2, CoreWebView2WebMessageReceivedEventArgs> _messageReceivedHandler;
		private Windows.Foundation.TypedEventHandler<CoreWebView2, CoreWebView2NavigationStartingEventArgs> _navigationStartingHandler;
		private Windows.Foundation.TypedEventHandler<CoreWebView2, CoreWebView2NavigationCompletedEventArgs> _navigationCompletedHandler;

		private const string ContentMonitoringScript = @"
            (function() {
                // Prevent multiple injections
                if (window.__contentMonitorInjected) {
                    console.log('Content monitor already injected');
                    return;
                }
                window.__contentMonitorInjected = true;

                function notifyContentChange() {
                    chrome.webview.postMessage('contentChanged');
                }

                // Monitor DOM changes - optimized to watch only specific attributes
                const observer = new MutationObserver((mutations) => {
                    // Look for significant changes
                    const hasSignificantChanges = mutations.some(mutation =>
                        mutation.addedNodes.length > 0 ||
                        mutation.removedNodes.length > 0 ||
                        (mutation.target.id && (
                            mutation.target.id.includes('content') ||
                            mutation.target.id.includes('main') ||
                            mutation.target.id.includes('root')
                        ))
                    );

                    if (hasSignificantChanges) {
                        notifyContentChange();
                    }
                });

                if (document.body) {
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true,
                        attributeFilter: ['class', 'style', 'data-loaded']
                    });

                    // Monitor clicks
                    document.addEventListener('click', () => {
                        setTimeout(notifyContentChange, 500);
                    }, true);
                }

                console.log('Content monitoring script injected');
            })();";

		private async Task InjectContentMonitoringScriptAsync()
		{
			try
			{
				if (PlatformView?.CoreWebView2 != null)
				{
					Console.WriteLine("[Windows] Injecting content monitoring script");
					await PlatformView.CoreWebView2.ExecuteScriptAsync(ContentMonitoringScript);
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"[Windows] Error injecting content monitoring script: {ex.Message}");
			}
		}

		protected override async void ConnectHandler(Microsoft.UI.Xaml.Controls.WebView2 platformView)
		{
			base.ConnectHandler(platformView);

			try
			{
				if (platformView.CoreWebView2 == null)
				{
					await platformView.EnsureCoreWebView2Async();
				}

				// Create event handlers
				_newWindowHandler = OnNewWindowRequested;
				_downloadHandler = OnDownloadStarting;

				// Now it's safe to attach event handlers
				platformView.CoreWebView2.NewWindowRequested += _newWindowHandler;
				platformView.CoreWebView2.DownloadStarting += _downloadHandler;

				// Track the last URL to detect changes
				string lastUrl = string.Empty;

				// Monitor source URL changes
				_sourceChangedHandler = async (sender, args) =>
				{
					var currentUrl = platformView.CoreWebView2?.Source;
					Console.WriteLine($"[Windows] Source changed to: {currentUrl}");

					if (currentUrl != lastUrl)
					{
						lastUrl = currentUrl;
						Console.WriteLine("[Windows] URL changed, updating page data...");

						// Give the page a moment to update its content
						await Task.Delay(500);
						await OnPageDataChangedAsync();
					}
				};
				platformView.CoreWebView2.SourceChanged += _sourceChangedHandler;

				// Setup message handler for content changes
				_messageReceivedHandler = async (sender, args) =>
				{
					Console.WriteLine($"[Windows] Received content change message");
					await OnPageDataChangedAsync();
				};
				platformView.CoreWebView2.WebMessageReceived += _messageReceivedHandler;

				// Add pre-navigation check
				_navigationStartingHandler = async (sender, args) =>
				{
					var url = args?.Uri;
					Console.WriteLine($"[Windows] Navigation Starting to: {url}");

					if (!string.IsNullOrEmpty(url) && IsPotentialPdfUrl(url))
					{
						Console.WriteLine("[Windows] PDF detected, reading content in parallel...");
						// Don't cancel navigation, just process PDF in parallel
						_ = Task.Run(async () => await HandlePotentialPdfUrl(url));
					}
				};
				platformView.CoreWebView2.NavigationStarting += _navigationStartingHandler;

				// Inject monitoring script after each navigation completes
				_navigationCompletedHandler = async (sender, args) =>
				{
					var webView = sender as CoreWebView2;
					Console.WriteLine($"[Windows] Navigation Completed: {webView?.Source}, IsSuccess: {args.IsSuccess}");

					if (args.IsSuccess)
					{
						// Re-inject the content monitoring script after each navigation
						await InjectContentMonitoringScriptAsync();

						// Trigger page data extraction
						await OnPageDataChangedAsync();
					}
				};
				platformView.CoreWebView2.NavigationCompleted += _navigationCompletedHandler;

				// Inject for initial page
				await InjectContentMonitoringScriptAsync();

				// Set the User-Agent
				SetUserAgent(VirtualView?.UserAgent);
			}
			catch (Exception ex)
			{
				Console.WriteLine($"[Windows] Error in ConnectHandler: {ex}");
			}
		}

		protected override void DisconnectHandler(Microsoft.UI.Xaml.Controls.WebView2 platformView)
		{
			if (platformView?.CoreWebView2 != null)
			{
				if (_newWindowHandler != null)
					platformView.CoreWebView2.NewWindowRequested -= _newWindowHandler;

				if (_downloadHandler != null)
					platformView.CoreWebView2.DownloadStarting -= _downloadHandler;

				if (_sourceChangedHandler != null)
					platformView.CoreWebView2.SourceChanged -= _sourceChangedHandler;

				if (_messageReceivedHandler != null)
					platformView.CoreWebView2.WebMessageReceived -= _messageReceivedHandler;

				if (_navigationStartingHandler != null)
					platformView.CoreWebView2.NavigationStarting -= _navigationStartingHandler;

				if (_navigationCompletedHandler != null)
					platformView.CoreWebView2.NavigationCompleted -= _navigationCompletedHandler;

				_newWindowHandler = null;
				_downloadHandler = null;
				_sourceChangedHandler = null;
				_messageReceivedHandler = null;
				_navigationStartingHandler = null;
				_navigationCompletedHandler = null;
			}

			base.DisconnectHandler(platformView);
		}

		public async Task ForcePageDataUpdate()
		{
			try
			{
				Console.WriteLine("[Windows] Manually triggering page data update...");
				if (PlatformView?.CoreWebView2 != null)
				{
					await PlatformView.CoreWebView2.ExecuteScriptAsync(@"
                console.log('Manual update triggered');
                chrome.webview.postMessage(JSON.stringify({
                    type: 'contentChanged',
                    url: window.location.href,
                    trigger: 'manual'
                }));
            ");
				}
				else
				{
					Console.WriteLine("[Windows] CoreWebView2 not available");
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"[Windows] Error in ForcePageDataUpdate: {ex}");
			}
		}

		public partial async Task InjectJavaScriptAsync(string script)
		{
			await PlatformView.CoreWebView2.ExecuteScriptAsync(script);
		}

		private void OnNewWindowRequested(CoreWebView2 sender, CoreWebView2NewWindowRequestedEventArgs args)
		{
			sender.Navigate(args.Uri);
			args.Handled = true;
		}

		private async void OnDownloadStarting(CoreWebView2 sender, CoreWebView2DownloadStartingEventArgs args)
		{
			Console.WriteLine($"[Windows] Download starting: {args.DownloadOperation.Uri}");
			var url = args.DownloadOperation.Uri;

			if (IsPotentialPdfUrl(url))
			{
				Console.WriteLine("[Windows] PDF download detected");
				args.Handled = true;
				await HandlePotentialPdfUrl(url);
			}
			else if (args.ResultFilePath.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
			{
				Console.WriteLine("[Windows] PDF file extension detected");
				args.Handled = true;
				await HandlePotentialPdfUrl(url);
			}
			else
			{
				Console.WriteLine($"[Windows] Non-PDF download: {args.ResultFilePath}");
				Process.Start(new ProcessStartInfo(args.ResultFilePath) { UseShellExecute = true });
				args.Cancel = false;
			}
		}

		public async void SetUserAgent(string userAgent)
		{
			if (PlatformView.CoreWebView2 == null)
			{
				// Wait for initialization
				await PlatformView.EnsureCoreWebView2Async();
			}

			// Now set the User-Agent
			PlatformView.CoreWebView2.Settings.UserAgent = userAgent ??
				"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
		}

		public async partial Task<PageData> ExtractPageDataAsync()
		{
			try
			{
				if (PlatformView?.CoreWebView2 == null)
				{
					if (PlatformView == null)
						return new PageData { Title = "Error", Body = "WebView not initialized." };

					await PlatformView.EnsureCoreWebView2Async();
				}

				using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(10));
				var scriptTask = PlatformView.CoreWebView2.ExecuteScriptAsync(PageDataExtractor.ExtractScript).AsTask();
				var completedTask = await Task.WhenAny(scriptTask, Task.Delay(Timeout.Infinite, cts.Token));

				if (completedTask != scriptTask)
				{
					Console.WriteLine("[Windows] JavaScript execution timed out");
					return new PageData { Title = "Timeout", Body = "Page data extraction timed out." };
				}

				string result = await scriptTask;

				if (!string.IsNullOrWhiteSpace(result))
				{
					result = result.Trim('"')
							   .Replace("\\\"", "\"")
							   .Replace("\\n", " ")
							   .Replace("\\r", " ")
							   .Replace("\\t", " ")
							   .Replace("\\\\", "\\");

					var rawData = JsonSerializer.Deserialize<PageRawData>(result, new JsonSerializerOptions
					{
						PropertyNameCaseInsensitive = true
					});

					var bodyText = DecodeBase64(rawData.Body);
					var routes = PageDataExtractor.ProcessLinks(rawData.Links, rawData.Url);
					var bodyRoutes = PageDataExtractor.ProcessLinks(rawData.BodyLinks, rawData.Url);

					return new PageData
					{
						Title = rawData.Title,
						Body = bodyText,
						Url = rawData.Url,
						Routes = routes,
						BodyRoutes = bodyRoutes
					};
				}

				return new PageData { Title = "No Content", Body = "Page content could not be retrieved." };
			}
			catch (JsonException ex)
			{
				Console.WriteLine($"[Windows] JSON parsing error: {ex.Message}");
				return new PageData { Title = "Error", Body = $"Failed to parse page content: {ex.Message}" };
			}
			catch (Exception ex)
			{
				Console.WriteLine($"[Windows] Error extracting page data: {ex.Message}");
				return new PageData { Title = "Error", Body = $"Failed to extract page data: {ex.Message}" };
			}
		}

	}
}
