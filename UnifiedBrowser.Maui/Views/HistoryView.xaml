<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:dx="http://schemas.devexpress.com/maui"
             xmlns:core="clr-namespace:UnifiedData.Maui.Core;assembly=UnifiedData.Maui"
             xmlns:converters="clr-namespace:UnifiedBrowser.Maui.Converters"
             x:Class="UnifiedBrowser.Maui.Views.HistoryView"
             x:Name="HistoryViewRoot">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter"/>
            <converters:IsFavoriteConverter x:Key="IsFavoriteConverter"/>
        </ResourceDictionary>
    </ContentView.Resources>

    <Grid BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#1C1C1E}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <dx:DXToolbar x:Name="HistoryToolbar" Grid.Row="0">
            <!-- Topics Page -->
            <dx:ToolbarPage Name="SearchPage">
                <dx:ToolbarCustomItem HorizontalOptions="FillAndExpand">
                    <dx:TextEdit x:Name="SearchEntry"
                                 PlaceholderText="Search..."
                                 Text="{Binding SearchQuery, Mode=TwoWay}"
                                 ClearIconVisibility="Auto"
                                 TextColor="{AppThemeBinding Light=Black, Dark=White}"
                                 PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#666666}"
                                 BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"
                                 BoxMode="Outlined"
                                 StartIcon="search"
                                 ReturnType="Search"
                                 FocusedBorderColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                                 HeightRequest="40"
                                 HorizontalOptions="FillAndExpand"
                                 BoxPadding="10,10"
                                 MinimumWidthRequest="200"/>
                </dx:ToolbarCustomItem>
            </dx:ToolbarPage>
            
            <dx:ToolbarPage Name="TopicsPage">
                <dx:ToolbarCustomItem>
                    <dx:ChoiceChipGroup x:Name="TopicChipGroup"
                        ItemsSource="{Binding TopicGroups}"
                        Padding="5"
                        AllowDeselect="True"
                        ChipUseRippleEffect="True"
                        IsMultiline="False"
                        DisplayMember="TopicName"
                        IsScrollBarVisible="False"
                        ChipTextColor="{StaticResource Gray400}"
                        ChipCornerRadius="20"
                        ChipBorderThickness="0"
                        ChipSelectedTextColor="White"
                        ChipBorderColor="{StaticResource Gray400}"
                        ChipTapCommand="{Binding FilterByTopicCommand}"
                        HorizontalOptions="Center"/>
                </dx:ToolbarCustomItem>
            </dx:ToolbarPage>

            <!-- Dates Page -->
            <dx:ToolbarPage Name="DatesPage">
                <dx:ToolbarCustomItem>
                    <dx:ChoiceChipGroup x:Name="DateChipGroup"
                        ItemsSource="{Binding DateGroups}"
                        Padding="5"
                        AllowDeselect="True"
                        ChipUseRippleEffect="True"
                        IsMultiline="False"
                        DisplayMember="DisplayText"
                        IsScrollBarVisible="False"
                        ChipTextColor="{StaticResource Gray400}"
                        ChipCornerRadius="20"
                        ChipBorderThickness="0"
                        ChipSelectedTextColor="White"
                        ChipBorderColor="{StaticResource Gray400}"
                        ChipTapCommand="{Binding FilterByDateCommand}"
                        HorizontalOptions="Center"/>
                </dx:ToolbarCustomItem>
            </dx:ToolbarPage>

            <dx:ToolbarToggleButton Icon="star"
                            ShowIcon="True"
                            ShowContent="False"
                            IsChecked="{Binding IsFavorite, Mode=TwoWay}"
                            IconColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                            ToolTipProperties.Text="Toggle favorite"
                            Placement="FixedLeft"/>
            <dx:ToolbarSeparator Placement="FixedLeft"/>
            <!-- Navigation Buttons -->
            <dx:ToolbarNavigationButton Icon="search"
                                    ShowIcon="True"
                                    ShowContent="False"
                                    PageName="SearchPage"
                                    Placement="FixedLeft"
                                    IconColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                                    ToolTipProperties.Text="Topics"/>
            <dx:ToolbarNavigationButton Icon="tag"
                                    ShowIcon="True"
                                    ShowContent="False"
                                    PageName="TopicsPage"
                                    Placement="FixedLeft"
                                    IconColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                                    ToolTipProperties.Text="Topics"/>
            <dx:ToolbarNavigationButton Icon="calendar"
                                    ShowIcon="True"
                                    ShowContent="False"
                                    PageName="DatesPage"
                                    Placement="FixedLeft"
                                    IconColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                                    ToolTipProperties.Text="Dates"/>

            <dx:ToolbarSeparator Placement="FixedRight"/>
            <dx:ToolbarButton Icon="trash"
                            ShowIcon="True"
                            ShowContent="False"
                            Command="{Binding ClearHistoryCommand}"
                            IconColor="{AppThemeBinding Light=#FF3B30, Dark=#FF453A}"
                            ToolTipProperties.Text="Clear All"
                            Placement="FixedRight"/>
        </dx:DXToolbar>

        <!-- Content Area -->
        <Grid Grid.Row="1">
            <!-- Loading Indicator -->
            <VerticalStackLayout IsVisible="{Binding IsLoading}"
                                VerticalOptions="Center"
                                HorizontalOptions="Center"
                                Spacing="20">
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                  Color="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                                  HeightRequest="40"
                                  WidthRequest="40"/>
                <Label Text="Loading history..."
                       FontSize="16"
                       TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                       HorizontalOptions="Center"/>
            </VerticalStackLayout>

            <!-- Empty State -->
            <VerticalStackLayout IsVisible="{Binding IsEmpty}"
                                VerticalOptions="Center"
                                HorizontalOptions="Center"
                                Spacing="20">
                <Label Text="ðŸ“œ"
                       FontSize="64"
                       HorizontalOptions="Center"/>
                <Label Text="No browsing history"
                       FontSize="18"
                       TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                       HorizontalOptions="Center"/>
                <Label Text="Pages you visit will appear here"
                       FontSize="14"
                       TextColor="{AppThemeBinding Light=#999999, Dark=#777777}"
                       HorizontalOptions="Center"/>
            </VerticalStackLayout>

            <!-- History List -->
            <dx:DXCollectionView x:Name="HistoryCollectionView"
                                ItemsSource="{Binding FilteredHistoryItems}"
                                SelectionMode="Single"
                                Margin="10"
                                BackgroundColor="Transparent"
                                IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                                IsPullToRefreshEnabled="True"
                                IsRefreshing="{Binding IsRefreshing}"
                                PullToRefreshCommand="{Binding RefreshHistoryCommand}">

            <dx:DXCollectionView.ItemTemplate>
                <DataTemplate x:DataType="core:UnifiedDocument">
                    <Border BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"
                            StrokeThickness="0"
                            Margin="0,0,0,10"
                            Padding="15"
                            TouchEffect.Command="{Binding Source={x:Reference HistoryViewRoot}, Path=BindingContext.NavigateToHistoryItemCommand}"
                            TouchEffect.CommandParameter="{Binding .}"
                            TouchEffect.LongPressCommand="{Binding Source={x:Reference HistoryViewRoot}, Path=BindingContext.CopyUrlToClipboardCommand}"
                            TouchEffect.LongPressCommandParameter="{Binding .}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <Border.Shadow>
                            <Shadow Offset="0,2"
                                    Radius="4"
                                    Opacity="0.1"
                                    Brush="{AppThemeBinding Light=Black, Dark=White}"/>
                        </Border.Shadow>

                        <Grid RowDefinitions="Auto,Auto,Auto,Auto">
                            <!-- Title -->
                            <Label Grid.Row="0"
                                   Text="{Binding Title}"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   LineBreakMode="TailTruncation"
                                   MaxLines="2"
                                   TextColor="{AppThemeBinding Light=Black, Dark=White}"/>

                            <!-- URL -->
                            <Label Grid.Row="1"
                                   Text="{Binding SourceUrl}"
                                   FontSize="12"
                                   LineBreakMode="TailTruncation"
                                   MaxLines="1"
                                   Margin="0,5,0,0"
                                   TextColor="{AppThemeBinding Light=#007ACC, Dark=#4A9FD5}"/>

                            <!-- Summary/Brief -->
                            <Label Grid.Row="2"
                                   Text="{Binding Summary}"
                                   FontSize="14"
                                   LineBreakMode="TailTruncation"
                                   MaxLines="3"
                                   Margin="0,8,0,0"
                                   TextColor="{AppThemeBinding Light=#333333, Dark=#CCCCCC}"/>

                            <!-- Metadata Row -->
                            <Grid Grid.Row="3"
                                  ColumnDefinitions="Auto,*,Auto,Auto"
                                  Margin="0,10,0,0">

                                <!-- Date -->
                                <HorizontalStackLayout Grid.Column="0" Spacing="5">
                                    <Label Text="ðŸ“…"
                                           FontSize="12"
                                           VerticalOptions="Center"/>
                                    <Label Text="{Binding CreatedAt, StringFormat='{0:MMM d, yyyy}'}"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                                           VerticalOptions="Center"/>
                                </HorizontalStackLayout>

                                <!-- Favorite Indicator -->
                                <Label Grid.Column="2"
                                       Text="â­"
                                       FontSize="14"
                                       VerticalOptions="Center"
                                       Margin="0,0,8,0"
                                       IsVisible="{Binding Visibility, Converter={StaticResource IsFavoriteConverter}}"/>

                                <!-- Delete Button -->
                                <dx:DXButton Grid.Column="3"
                                            Icon="trash"
                                            ShowIcon="True"
                                            ShowContent="False"
                                            IconColor="{AppThemeBinding Light=#FF3B30, Dark=#FF453A}"
                                            BackgroundColor="Transparent"
                                            Command="{Binding Source={x:Reference HistoryViewRoot}, Path=BindingContext.DeleteHistoryItemCommand}"
                                            CommandParameter="{Binding .}"
                                            WidthRequest="32"
                                            HeightRequest="32"/>
                            </Grid>
                        </Grid>
                    </Border>
                </DataTemplate>
            </dx:DXCollectionView.ItemTemplate>

            <dx:DXCollectionView.GroupHeaderTemplate>
                <DataTemplate>
                    <Border BackgroundColor="{AppThemeBinding Light=#F0F0F0, Dark=#3A3A3C}"
                            Padding="15,8"
                            Margin="0,5,0,10">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8"/>
                        </Border.StrokeShape>
                        <Label Text="{Binding Key}"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                    </Border>
                </DataTemplate>
            </dx:DXCollectionView.GroupHeaderTemplate>
            </dx:DXCollectionView>
        </Grid>
    </Grid>
</ContentView>
